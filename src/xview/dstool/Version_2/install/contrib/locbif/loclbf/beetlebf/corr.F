C  -------------------------------------------------------------------
C
C	Copyright (1990-1995) by Alexander Khibnik, Yuri Kuznetsov, and 
C	Eugene Nikolaev.
C
C The Locbif computation code in DsTool is distributed in the hope that it  
C will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty  
C of FITNESS FOR A PARTICULAR PURPOSE.  The software is provided as is without 
C any obligation on the part of Locbif authors, Cornell faculty, 
C Cornell staff or Cornell students to assist in its use, correction, 
C modification or enhancement. 
C
C  -------------------------------------------------------------------

      SUBROUTINE CORR (NX,NDIMM,NFIX1,NFIX,VMOVE,DMOVE,DFUN)
C     3.05.90.
C     13.11.92
C     15.06.94
C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
C*                                                                     *
C*    Subroutine CORR serves for:
C*       1) correction of 
C*       1) KOPPEK KACATEHOO BEKTOPA;                            *
C*       2) CMEH MATP, HEOXOMO  KOHTPO TOEK              *
C*          CAMOEPECEEH;                                           *
C*    POPAMMA CORR BBAETC TOKO TOA, KOA POCXOT AMEHA  *
C*    KCPOBAHHO EPEMEHHO.                                        *
C*                                                                     *
C*    CCOK OPMAHX  A P A M E T P O B:                           *
C*                                                                     *
C*    NX   -PAMEPHOCT POCTPAHCTBA EPEMEHHX;                       *
C*    NDIM -ABEHHA CTPOHA PAMEPHOCT MATP DFUN;              *
C*    NFIX1-CTAPOE HAEHE KCPOBAHHO EPEMEHHO;                  *
C*    NFIX -HOBOE HAEHE KCPOBAHHO EPEMEHHO;                   *
C*    VMOVE-HA BXOE: KOOPHAT KACATEHOO BEKTOPA C VMOVE(NFIX1)>0;*
C*          HA BXOE:KOOPHAT KACATEHOO BEKTOPA C VMOVE(NFIX)>0; *
C*    DMOVE-A BO KPBO: HA BXOE  HA BXOE  POPAMM,       *
C*          BEHA  DMOVE*VMOVE(NFIX1) COXPAHET HAK;               *
C*    DFUN -MATPA ACTHX POBOHX.                               *
C*. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .*
C*                                                                     *
C*    BBAEME POPAMM: DECOMP.                                    *
C*                                                                     *
C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
C*   P MEHEH MAKCMAHOO CA EPEMEHHX  NDIM  HEOXOMO    *
C*   MEHT PAMEPHOCT MACCBOB: A(*,*) IPVT(*) WORK(*)             *
C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
C
      IMPLICIT REAL*8 (A-H,O-Z)
      IMPLICIT INTEGER*2 (I-N)
      include 'beetlebf.dim'
      DIMENSION VMOVE(NX), DFUN(NDIM,NX), IPVT(NDIM), WORK(NDIM)
      COMMON /CORR1/ DET, COND,SGNDET
      COMMON /LEQV1/ DETL, CONDL
C
      COMMON /WORKBE/ ARR1(NDIM,NDIM), A(NDIM,NDIM)
C
C.... KOPPEK OPEHTA KACATEHOO BEKTOPA.
C
c      WRITE (6,*) ' CORR:  DET=',DET,'  DETL=',DETL
      IF (VMOVE(NFIX) .GT. 0.D0) GOTO 210
          DO 200 I=1,NX
             VMOVE(I) = -1.D0*VMOVE(I)
 200      CONTINUE
          DMOVE = -1.D0*DMOVE
 210  CONTINUE
C
C.... KOPPEK MATP ACTHX POBOHX.
C
      DFUN(NX,NFIX1) = 0.0D0
      DFUN(NX,NFIX)  = 1.0D0
C
C.... OOTOBKA PAOE MATP A  BCEH OPEETE.
C
      DO 230 I=1,NX
         DO 220 J=1,NX
            A(I,J) = DFUN(I,J)
 220     CONTINUE
 230  CONTINUE
C
C.... BCEHE OPEETE (DET), COOTBETCTBEO HOBO
C     KCPOBAHHO EPEMEHHO  NFIX.
C
      CALL DECOMP (NDIM,NX,A,COND,IPVT,WORK)
      DET = IPVT(NX)
      DO 310 I=1,NX
         DET = DET*A(I,I)
 310  CONTINUE
c      WRITE (6,*) ' CORR:  DET=',DET,'  DETL=',DETL
      RETURN
      END
